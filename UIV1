local Library = {}

function Library:CreateWindow(windowName)
	local TweenService = game:GetService("TweenService")
	local UserInputService = game:GetService("UserInputService")
	local CoreGui = game:GetService("CoreGui")

	-- Xóa GUI cũ nếu tồn tại
	if CoreGui:FindFirstChild("ToanLuaLib") then
		CoreGui.ToanLuaLib:Destroy()
	end

	local menu = Instance.new("ScreenGui")
	menu.Name = "ToanLuaLib"
	menu.Parent = CoreGui
	menu.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

	local frame = Instance.new("Frame")
	frame.Name = "MainFrame"
	frame.Size = UDim2.new(0, 150, 0, 260)
	frame.Position = UDim2.new(0.5, -75, 0.5, -130)
	frame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
	frame.BorderSizePixel = 0
	frame.Parent = menu
	
	local uiCornerFrame = Instance.new("UICorner")
	uiCornerFrame.CornerRadius = UDim.new(0, 4)
	uiCornerFrame.Parent = frame

	local header = Instance.new("Frame")
	header.Name = "Header"
	header.Size = UDim2.new(1, 0, 0, 16)
	header.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
	header.BorderSizePixel = 0
	header.Parent = frame
	
	local uiCornerHeader = Instance.new("UICorner")
	uiCornerHeader.CornerRadius = UDim.new(0, 4)
	uiCornerHeader.Parent = header

	local headerGradient = Instance.new("UIGradient")
	headerGradient.Color = ColorSequence.new{
		ColorSequenceKeypoint.new(0, Color3.fromRGB(80, 120, 200)),
		ColorSequenceKeypoint.new(1, Color3.fromRGB(40, 80, 160))
	}
	headerGradient.Rotation = -15
	headerGradient.Parent = header

	local title = Instance.new("TextLabel")
	title.Name = "Title"
	title.Size = UDim2.new(0, 60, 1, 0)
	title.Position = UDim2.new(0, 6, 0, 0)
	title.BackgroundTransparency = 1
	title.Text = windowName or "GUI MENU"
	title.TextColor3 = Color3.fromRGB(240, 240, 240)
	title.Font = Enum.Font.GothamBold
	title.TextSize = 7
	title.TextXAlignment = Enum.TextXAlignment.Left
	title.Parent = header

	-- --- Control Buttons (Close/Minimize) ---
	local function createControlButton(name, text, position, size)
		local button = Instance.new("TextButton")
		button.Name = name
		button.Size = UDim2.new(0, 16, 0, 16)
		button.Position = UDim2.new(1, position, 0, 0)
		button.BackgroundTransparency = 1
		button.Text = text
		button.TextColor3 = Color3.fromRGB(240, 240, 240)
		button.Font = Enum.Font.GothamBold
		button.TextSize = size
		button.Parent = header

		button.MouseEnter:Connect(function()
			TweenService:Create(button, TweenInfo.new(0.2), { TextColor3 = Color3.new(1, 1, 1) }):Play()
		end)
		button.MouseLeave:Connect(function()
			TweenService:Create(button, TweenInfo.new(0.2), { TextColor3 = Color3.fromRGB(240, 240, 240) }):Play()
		end)
		return button
	end

	local closeButton = createControlButton("CloseButton", "×", -16, 9)
	local minimizeButton = createControlButton("MinimizeButton", "−", -32, 9)

	-- --- Content Area ---
	local content = Instance.new("ScrollingFrame")
	content.Name = "Content"
	content.Size = UDim2.new(1, 0, 1, -21)
	content.Position = UDim2.new(0, 0, 0, 16)
	content.BackgroundTransparency = 1
	content.BorderSizePixel = 0
	content.ScrollBarThickness = 2
	content.ScrollBarImageColor3 = Color3.fromRGB(80, 120, 200)
	content.AutomaticCanvasSize = Enum.AutomaticSize.Y
	content.Parent = frame

	local contentLayout = Instance.new("UIListLayout")
	contentLayout.Padding = UDim.new(0, 4)
	contentLayout.SortOrder = Enum.SortOrder.LayoutOrder
	contentLayout.Parent = content

	local contentPadding = Instance.new("UIPadding")
	contentPadding.PaddingLeft = UDim.new(0, 5)
	contentPadding.PaddingRight = UDim.new(0, 5)
	contentPadding.PaddingTop = UDim.new(0, 5)
	contentPadding.PaddingBottom = UDim.new(0, 5)
	contentPadding.Parent = content

	-- --- Resize Logic ---
	local resizeHandle = Instance.new("Frame")
	resizeHandle.Name = "ResizeHandle"
	resizeHandle.Size = UDim2.new(0, 10, 0, 10)
	resizeHandle.Position = UDim2.new(1, -10, 1, -10)
	resizeHandle.BackgroundColor3 = Color3.fromRGB(80, 120, 200)
	resizeHandle.BorderSizePixel = 0
	resizeHandle.Parent = frame
	local uiCornerResize = Instance.new("UICorner")
	uiCornerResize.CornerRadius = UDim.new(0, 2)
	uiCornerResize.Parent = resizeHandle

	-- Logic Minimize
	local minimized = false
	local originalSize = frame.Size
	local originalHeaderSize = UDim2.new(1, 0, 0, 16)
	local originalMinimizePos = UDim2.new(1, -32, 0, 0)

	minimizeButton.MouseButton1Click:Connect(function()
		minimized = not minimized
		local tweenInfo = TweenInfo.new(0.3, Enum.EasingStyle.Cubic, Enum.EasingDirection.Out)
		if minimized then
			originalSize = frame.Size
			TweenService:Create(frame, tweenInfo, { Size = UDim2.new(0, 20, 0, 20) }):Play()
			TweenService:Create(header, tweenInfo, { Size = UDim2.new(1, 0, 1, 0) }):Play()
			minimizeButton.Text = "+"
			minimizeButton.Position = UDim2.new(0.5, -8, 0.5, -8)
			content.Visible = false
			title.Visible = false
			closeButton.Visible = false
			resizeHandle.Visible = false
			headerGradient.Transparency = NumberSequence.new(1)
		else
			TweenService:Create(frame, tweenInfo, { Size = originalSize }):Play()
			TweenService:Create(header, tweenInfo, { Size = originalHeaderSize }):Play()
			minimizeButton.Text = "−"
			minimizeButton.Position = originalMinimizePos
			content.Visible = true
			title.Visible = true
			closeButton.Visible = true
			resizeHandle.Visible = true
			headerGradient.Transparency = NumberSequence.new(0)
		end
	end)

	closeButton.MouseButton1Click:Connect(function()
		menu:Destroy()
	end)

	-- Logic Dragging
	local dragging = false
	local dragInput, dragStart, startPos
	header.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
			dragging = true
			dragStart = input.Position
			startPos = frame.Position
			local conn
			conn = input.Changed:Connect(function()
				if input.UserInputState == Enum.UserInputState.End then
					dragging = false
					conn:Disconnect()
				end
			end)
		end
	end)
	header.InputChanged:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
			dragInput = input
		end
	end)
	UserInputService.InputChanged:Connect(function(input)
		if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
			local delta = input.Position - dragStart
			frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
		end
	end)

	-- Logic Resizing
	local resizing = false
	local resizeStart, startSize
	resizeHandle.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
			resizing = true
			resizeStart = input.Position
			startSize = frame.Size
			local conn
			conn = input.Changed:Connect(function()
				if input.UserInputState == Enum.UserInputState.End then
					resizing = false
					conn:Disconnect()
				end
			end)
		end
	end)
	UserInputService.InputChanged:Connect(function(input)
		if resizing and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
			local delta = input.Position - resizeStart
			local newWidth = startSize.X.Offset + delta.X
			local newHeight = startSize.Y.Offset + delta.Y
			newWidth = math.max(100, newWidth)
			newHeight = math.max(100, newHeight)
			frame.Size = UDim2.new(0, newWidth, 0, newHeight)
		end
	end)

	-- --- Element Functions ---
	local WindowFunctions = {}

	-- 1. Button Thường
	function WindowFunctions:AddButton(text, callback)
		local callback = callback or function() end
		local button = Instance.new("TextButton")
		button.Name = text .. "Button"
		button.Size = UDim2.new(1, 0, 0, 18)
		button.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
		button.TextColor3 = Color3.fromRGB(220, 220, 220)
		button.Font = Enum.Font.GothamSemibold
		button.TextSize = 7
		button.Text = text
		button.Parent = content
		
		local corner = Instance.new("UICorner")
		corner.CornerRadius = UDim.new(0, 2)
		corner.Parent = button
		
		local stroke = Instance.new("UIStroke")
		stroke.Color = Color3.fromRGB(50, 50, 55)
		stroke.Thickness = 1
		stroke.Parent = button

		button.MouseButton1Click:Connect(function()
			button.TextColor3 = Color3.fromRGB(120, 220, 120)
			pcall(callback)
			wait(0.1)
			button.TextColor3 = Color3.fromRGB(220, 220, 220)
		end)
		return button
	end

	-- 2. Toggle Button
	function WindowFunctions:AddToggle(text, callback)
		local callback = callback or function() end
		local button = Instance.new("TextButton")
		button.Name = text .. "Toggle"
		button.Size = UDim2.new(1, 0, 0, 18)
		button.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
		button.TextColor3 = Color3.fromRGB(220, 220, 220)
		button.Font = Enum.Font.GothamSemibold
		button.TextSize = 7
		button.Text = text .. " [OFF]"
		button.Parent = content
		
		local corner = Instance.new("UICorner")
		corner.CornerRadius = UDim.new(0, 2)
		corner.Parent = button
		
		local stroke = Instance.new("UIStroke")
		stroke.Color = Color3.fromRGB(50, 50, 55)
		stroke.Thickness = 1
		stroke.Parent = button

		local toggled = false
		button.MouseButton1Click:Connect(function()
			toggled = not toggled
			local status = toggled and "[ON]" or "[OFF]"
			button.Text = text .. " " .. status
			button.TextColor3 = toggled and Color3.fromRGB(120, 220, 120) or Color3.fromRGB(220, 220, 220)
			pcall(callback, toggled)
		end)
		return button
	end

	-- 3. Cycle/Multi Mode
	function WindowFunctions:AddCycle(text, modes, callback)
		local callback = callback or function() end
		local modes = modes or {}
		local button = Instance.new("TextButton")
		button.Name = text .. "Cycle"
		button.Size = UDim2.new(1, 0, 0, 18)
		button.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
		button.TextColor3 = Color3.fromRGB(220, 220, 220)
		button.Font = Enum.Font.GothamSemibold
		button.TextSize = 7
		
		local stateIndex = 0
		local currentMode = modes[1] or "None"
		button.Text = text .. " [" .. currentMode .. "]"
		
		button.Parent = content
		local corner = Instance.new("UICorner")
		corner.CornerRadius = UDim.new(0, 2)
		corner.Parent = button
		
		local stroke = Instance.new("UIStroke")
		stroke.Color = Color3.fromRGB(50, 50, 55)
		stroke.Thickness = 1
		stroke.Parent = button

		button.MouseButton1Click:Connect(function()
			stateIndex = (stateIndex + 1) % #modes
			local displayIndex = stateIndex + 1
			currentMode = modes[displayIndex]
			
			button.Text = text .. " [" .. currentMode .. "]"
			button.TextColor3 = (stateIndex > 0) and Color3.fromRGB(120, 220, 120) or Color3.fromRGB(220, 220, 220)
			pcall(callback, currentMode)
		end)
		return button
	end

	return WindowFunctions
end

return Library
